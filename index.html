<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <title>TPA Tracker â€” Registro diario</title>
  <style>
    :root{--bg:#0b1020;--card:#11172b;--ink:#eef2ff;--muted:#9fb3c8;--accent:#0ea5e9;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0b1020,#0b1020cc 70%,#0b102000);backdrop-filter: blur(6px);padding:14px 12px;z-index:3}
    h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
    main{padding:12px;max-width:900px;margin:auto}
    .card{background:var(--card);border:1px solid #1c2544;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px;margin-bottom:12px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3560;background:#0f1528;color:var(--ink);outline:none}
    input[type=checkbox]{width:auto}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:repeat(3,1fr)}}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid #2a3560;background:#0f1528;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:white}
    .btn.ghost{background:transparent;border:1px dashed #2a3560}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1528;border:1px solid #2a3560;color:var(--muted);font-size:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:10px;border:1px solid #202c55;border-radius:12px;background:#0e1427}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .danger{color:#ffbcc3}
    .ok{color:#baf7d0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .footer{padding:14px 12px;color:var(--muted);text-align:center;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“‹ TPA Tracker <span class="pill">offline</span> <button id="installBtn" class="btn ghost right">Instalar</button></h1>
  </header>
  <main>
    <section class="card">
      <div class="row cols-3">
        <div><label>Fecha</label><input type="date" id="fecha"></div>
        <div><label>Hora</label><input type="time" id="hora"></div>
        <div><label>Lugar</label><input id="lugar" placeholder="mesa, cocina, trabajo..."></div>
      </div>
      <div class="row">
        <div><label>Comida y bebida</label><textarea id="comida" rows="2" placeholder="ej.: 1 sÃ¡ndwich, tÃ© con edulcorante"></textarea></div>
      </div>
      <div class="row cols-3">
        <div><label>Â¿Cantidad sentida como excesiva?</label><select id="excesiva"><option value=""></option><option value="*">SÃ­ (*)</option></select></div>
        <div><label>PC (pÃ©rdida de control 0â€“10)</label><input id="pc" type="number" min="0" max="10" step="1" value="0"></div>
        <div><label>Secreto</label><select id="secreto"><option value="N">N</option><option value="S">S</option></select></div>
      </div>
      <div class="row cols-3">
        <div><label>EmociÃ³n previa (palabra)</label><input id="emocion"></div>
        <div><label>EmociÃ³n (0â€“10)</label><input id="emocion_val" type="number" min="0" max="10" step="1" value="0"></div>
        <div><label>Culpa/AutocrÃ­tica (0â€“10)</label><input id="culpa" type="number" min="0" max="10" step="1" value="0"></div>
      </div>
      <div class="row cols-3">
        <div><label>V/L</label><select id="vl"><option value=""></option><option value="V">V</option><option value="L">L</option></select></div>
        <div><label>Â¿â‰¤4 h desde la anterior?</label><select id="menos4"><option value=""></option><option value="S">S</option><option value="N">N</option></select></div>
        <div><label>Comentarios</label><input id="comentarios" placeholder="2â€“3 palabras"></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="saveBtn">Guardar</button>
        <button class="btn" id="clearBtn">Limpiar</button>
        <span class="small">Los datos se guardan localmente en tu dispositivo.</span>
      </div>
    </section>

    <section class="card">
      <div class="flex">
        <strong>Entradas del dÃ­a</strong>
        <div class="right"></div>
        <button class="btn" id="exportCSV">Exportar CSV</button>
        <label class="btn ghost" for="importFile">Importar CSV</label>
        <input type="file" id="importFile" accept=".csv" style="display:none">
        <button class="btn danger" id="deleteAll">Borrar todo</button>
      </div>
      <div id="list" class="list" style="margin-top:10px"></div>
    </section>

    <section class="card">
      <div class="small">
        <strong>Tips rÃ¡pidos:</strong>
        â€¢ AnotÃ¡ <em>en el momento</em> â€¢ Si el impulso aparece, probÃ¡ tu lista de alternativas 10â€™ â€¢ Si hubo desliz, volvÃ© al plan en la prÃ³xima comida.
      </div>
    </section>
  </main>
  <div class="footer">Hecho para Luis Â· Funciona offline tras la primera carga</div>

<script>
// --- PWA install flow ---
let deferredPrompt;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});
installBtn.addEventListener('click', async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

// Register SW
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js');
  });
}

// --- Storage helpers ---
const KEY = 'tpa-tracker-v1';
function loadAll(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || []; }catch(e){ return []; }
}
function saveAll(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

// --- UI elements ---
const $ = (id)=>document.getElementById(id);
const inputs = ['fecha','hora','lugar','comida','excesiva','pc','secreto','emocion','emocion_val','culpa','vl','menos4','comentarios'].map($);
const [fecha,hora,lugar,comida,excesiva,pc,secreto,emocion,emocion_val,culpa,vl,menos4,comentarios]=inputs;
const list = $('list');

function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
fecha.value = todayISO();

function clearForm(){
  hora.value='';
  lugar.value='';
  comida.value='';
  excesiva.value='';
  pc.value='0';
  secreto.value='N';
  emocion.value='';
  emocion_val.value='0';
  culpa.value='0';
  vl.value='';
  menos4.value='';
  comentarios.value='';
}
$('clearBtn').addEventListener('click', clearForm);

function render(){
  const all = loadAll();
  const byDate = all.filter(e=>e.fecha===fecha.value);
  list.innerHTML = '';
  if(byDate.length===0){
    list.innerHTML = '<div class="small">Sin registros para esta fecha.</div>';
    return;
  }
  byDate.sort((a,b)=> (a.hora||'').localeCompare(b.hora||''));
  for(const e of byDate){
    const el = document.createElement('div');
    el.className='item';
    el.innerHTML = `
      <div class="flex">
        <div><strong>${e.hora||'--:--'}</strong> Â· ${e.comida||''}</div>
        <span class="pill right mono">PC ${e.pc??'-'}</span>
      </div>
      <div class="small">Lugar: ${e.lugar||'-'} Â· EmociÃ³n: ${e.emocion||'-'} (${e.emocion_val??'-'}) Â· Culpa: ${e.culpa??'-'} Â· ${e.excesiva?'*':''} ${e.secreto==='S'?'Â· secreto':''} ${e.vl?('Â· '+e.vl):''} ${e.menos4?('Â· â‰¤4h: '+e.menos4):''}</div>
      <div class="small">${e.comentarios||''}</div>
      <div class="flex" style="margin-top:6px">
        <button class="btn" data-edit="${e.id}">Editar</button>
        <button class="btn danger" data-del="${e.id}">Borrar</button>
      </div>
    `;
    list.appendChild(el);
  }
}

function addOrUpdate(obj){
  const all = loadAll();
  const i = all.findIndex(x=>x.id===obj.id);
  if(i>=0) all[i]=obj; else all.push(obj);
  saveAll(all); render();
}

$('saveBtn').addEventListener('click', ()=>{
  const entry = {
    id: uid(),
    fecha: fecha.value,
    hora: hora.value,
    lugar: lugar.value.trim(),
    comida: comida.value.trim(),
    excesiva: excesiva.value==='*'?'*':'',
    pc: parseInt(pc.value||'0'),
    secreto: secreto.value,
    emocion: emocion.value.trim(),
    emocion_val: parseInt(emocion_val.value||'0'),
    culpa: parseInt(culpa.value||'0'),
    vl: vl.value,
    menos4: menos4.value,
    comentarios: comentarios.value.trim()
  };
  addOrUpdate(entry);
  clearForm();
});

list.addEventListener('click', (ev)=>{
  const t = ev.target;
  const all = loadAll();
  if(t.dataset.del){
    const id = t.dataset.del;
    saveAll(all.filter(e=>e.id!==id)); render();
  }
  if(t.dataset.edit){
    const id = t.dataset.edit;
    const e = all.find(x=>x.id===id);
    if(!e) return;
    // load into form for quick edit, keep same id
    hora.value=e.hora||''; lugar.value=e.lugar||''; comida.value=e.comida||''; excesiva.value=e.excesiva?'*':'';
    pc.value=e.pc??0; secreto.value=e.secreto||'N'; emocion.value=e.emocion||''; emocion_val.value=e.emocion_val??0;
    culpa.value=e.culpa??0; vl.value=e.vl||''; menos4.value=e.menos4||''; comentarios.value=e.comentarios||'';
    // when saved, reuse same id
    $('saveBtn').onclick = ()=>{
      const updated = {
        id: id,
        fecha: fecha.value,
        hora: hora.value,
        lugar: lugar.value.trim(),
        comida: comida.value.trim(),
        excesiva: excesiva.value==='*'?'*':'',
        pc: parseInt(pc.value||'0'),
        secreto: secreto.value,
        emocion: emocion.value.trim(),
        emocion_val: parseInt(emocion_val.value||'0'),
        culpa: parseInt(culpa.value||'0'),
        vl: vl.value,
        menos4: menos4.value,
        comentarios: comentarios.value.trim()
      };
      addOrUpdate(updated);
      $('saveBtn').onclick = defaultSave;
      clearForm();
    };
  }
});

function defaultSave(){}
$('saveBtn').onclick = defaultSave;

$('deleteAll').addEventListener('click', ()=>{
  if(confirm('Â¿Borrar TODOS los registros? Esta acciÃ³n no se puede deshacer.')){
    localStorage.removeItem(KEY); render();
  }
});

// Export CSV (todos los registros)
$('exportCSV').addEventListener('click', ()=>{
  const rows = loadAll();
  const headers = ["id","fecha","hora","lugar","comida","excesiva","pc","secreto","emocion","emocion_val","culpa","vl","menos4","comentarios"];
  const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>('"'+String(r[h] if(h in r) else '').replace(/"/g,'""')+'"')).join(','))).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tpa-tracker.csv';
  a.click();
});

// Import CSV (merge)
$('importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  const lines = text.trim().split(/\r?\n/);
  const headers = lines.shift().split(',');
  const all = loadAll();
  const ids = new Set(all.map(x=>x.id));
  for(const line of lines){
    const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"'));
    const obj = {};
    headers.forEach((h,i)=>obj[h]=cols[i]||'');
    if(!ids.has(obj.id)){
      obj.pc = parseInt(obj.pc||'0'); obj.emocion_val = parseInt(obj.emocion_val||'0'); obj.culpa = parseInt(obj.culpa||'0');
      all.push(obj); ids.add(obj.id);
    }
  }
  saveAll(all); render(); e.target.value='';
});

// Switch date re-renders list
fecha.addEventListener('change', render);

render();
</script>
</body>
</html>
